<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr BINS - Sistema ERP</title>
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn1.genspark.ai/user-upload-image/22_generated/e788f055-2e71-4833-af8f-ca8c47593acc">
    <link rel="icon" type="image/png" sizes="16x16" href="https://cdn1.genspark.ai/user-upload-image/22_generated/e788f055-2e71-4833-af8f-ca8c47593acc">
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn1.genspark.ai/user-upload-image/22_generated/e788f055-2e71-4833-af8f-ca8c47593acc">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-full-return {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            font-weight: 600;
            border: 2px solid #fff;
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
        .btn-full-return:hover {
            background: linear-gradient(135deg, #218838, #1ea085);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .metric-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .metric-card-blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .metric-card-green {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .metric-card-orange {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .logo-text {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .logout-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: 600;
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }
        .logout-btn:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
        }
        .bol-download-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .bol-download-btn:hover {
            background: linear-gradient(135deg, #218838, #1ea085);
            transform: translateY(-1px);
        }
        .bol-generate-btn {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .bol-generate-btn:hover {
            background: linear-gradient(135deg, #ff8f00, #ff6f00);
            transform: translateY(-1px);
        }

        /* BOL Template Styles */
        .bol-template {
            width: 210mm;
            height: 297mm;
            margin: 0 auto;
            padding: 20mm;
            background: white;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            color: #000;
            line-height: 1.4;
        }
        .bol-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .bol-logo {
            width: 200px;
            height: auto;
            margin-bottom: 20px;
        }
        .bol-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #000;
        }
        .bol-contact {
            font-size: 12px;
            border-top: 2px solid #000;
            border-bottom: 2px solid #000;
            padding: 10px 0;
            margin-bottom: 30px;
        }
        .bol-info-section {
            margin-bottom: 20px;
        }
        .bol-info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }
        .bol-info-label {
            font-weight: bold;
            width: 120px;
        }
        .bol-info-value {
            flex: 1;
            border-bottom: 1px solid #000;
            padding-bottom: 2px;
        }
        .bol-legal-text {
            font-size: 11px;
            line-height: 1.3;
            margin: 30px 0;
            text-align: justify;
        }
        .bol-charges {
            font-size: 11px;
            margin-left: 20px;
            line-height: 1.4;
        }
        .bol-shipping-info {
            font-size: 16px;
            font-weight: bold;
            margin: 30px 0;
        }
        .bol-signature-section {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
        }
        .bol-signature-box {
            width: 45%;
            border-bottom: 2px solid #000;
            padding-bottom: 40px;
            font-weight: bold;
        }
        @media print {
            .bol-template {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 15mm;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="logo-text mb-2">I ‚ù§Ô∏è üçÅ üçí</div>
                <h1 class="text-3xl font-bold text-gray-800">Mr BINS</h1>
                <p class="text-gray-600">Sistema ERP de Seguimiento</p>
            </div>
            
            <form id="loginForm">
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Usuario</label>
                    <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Contrase√±a</label>
                    <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <button type="submit" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-md">
                    <i class="fas fa-sign-in-alt mr-2"></i>INGRESAR
                </button>
            </form>
            
            <div class="mt-6 text-sm text-gray-600">
                <p><strong>Credenciales:</strong></p>
                <p>SHUKINS: shukins2025</p>
                <p>SMAGH: smagh2025</p>
                <p>Master: master2025</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white p-4 shadow-lg">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="logo-text">I ‚ù§Ô∏è üçÅ üçí</div>
                    <div>
                        <h1 class="text-2xl font-bold">Mr BINS</h1>
                        <p class="text-sm opacity-90">Sistema ERP de Seguimiento</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="toggleLanguage()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        <span id="langToggle">üá∫üá∏ English</span>
                    </button>
                    <span id="currentUser" class="text-sm opacity-90"></span>
                    <button onclick="logout()" class="logout-btn">
                        <i class="fas fa-sign-out-alt mr-2"></i><span data-es="Cerrar Sesi√≥n" data-en="Logout">Cerrar Sesi√≥n</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white shadow-md">
            <div class="container mx-auto">
                <ul class="flex space-x-8 p-4">
                    <li><a href="#" onclick="showSection('dashboard')" class="nav-link text-gray-700 hover:text-blue-600 font-medium"><i class="fas fa-tachometer-alt mr-2"></i><span data-es="Dashboard" data-en="Dashboard">Dashboard</span></a></li>
                    <li><a href="#" onclick="showSection('movements')" class="nav-link text-gray-700 hover:text-blue-600 font-medium"><i class="fas fa-exchange-alt mr-2"></i><span data-es="Movimientos" data-en="Movements">Movimientos</span></a></li>
                    <li><a href="#" onclick="showSection('reports')" class="nav-link text-gray-700 hover:text-blue-600 font-medium"><i class="fas fa-chart-bar mr-2"></i><span data-es="Reportes" data-en="Reports">Reportes</span></a></li>
                    <li><a href="#" onclick="showSection('settings')" class="nav-link text-gray-700 hover:text-blue-600 font-medium"><i class="fas fa-cog mr-2"></i><span data-es="Configuraci√≥n" data-en="Settings">Configuraci√≥n</span></a></li>
                </ul>
            </div>
        </nav>

        <!-- Content Area -->
        <main class="container mx-auto p-6">
            
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2" data-es="Dashboard" data-en="Dashboard">Dashboard</h2>
                    <p class="text-gray-600" data-es="Resumen operativo en tiempo real" data-en="Real-time operational summary">Resumen operativo en tiempo real</p>
                </div>

                <!-- Metrics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card p-6 rounded-lg shadow-lg card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90" data-es="Total BINS" data-en="Total BINS">Total BINS</p>
                                <p class="text-2xl font-bold" id="totalBins">750</p>
                            </div>
                            <i class="fas fa-boxes text-3xl opacity-50"></i>
                        </div>
                    </div>
                    
                    <div class="metric-card-blue p-6 rounded-lg shadow-lg card-hover text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90" data-es="Stock Disponible" data-en="Available Stock">Stock Disponible</p>
                                <p class="text-2xl font-bold" id="availableStock">750</p>
                            </div>
                            <i class="fas fa-warehouse text-3xl opacity-50"></i>
                        </div>
                    </div>
                    
                    <div class="metric-card-green p-6 rounded-lg shadow-lg card-hover text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90" data-es="Fruta en Hidrocooler" data-en="Fruit in Hidrocooler">Fruta en Hidrocooler</p>
                                <p class="text-2xl font-bold" id="fruitInHidrocooler">77</p>
                            </div>
                            <i class="fas fa-apple-alt text-3xl opacity-50"></i>
                        </div>
                    </div>
                    
                    <div class="metric-card-orange p-6 rounded-lg shadow-lg card-hover text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90" data-es="BINS Despachados" data-en="BINS Dispatched">BINS Despachados</p>
                                <p class="text-2xl font-bold" id="dispatchedBins">420</p>
                            </div>
                            <i class="fas fa-truck text-3xl opacity-50"></i>
                        </div>
                    </div>
                </div>

                <!-- Hidrocooler Status -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìç SHUKINS</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Stock Disponible:" data-en="Available Stock:">Stock Disponible:</span>
                                <span class="font-bold" id="shukinsStock">280/400 BINS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Fruta en Hidrocooler:" data-en="Fruit in Hidrocooler:">Fruta en Hidrocooler:</span>
                                <span class="font-bold" id="shukinsFruit">45 BINS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Con Growers:" data-en="With Growers:">Con Growers:</span>
                                <span class="font-bold" id="shukinsWithGrowers">25 BINS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Despachados:" data-en="Dispatched:">Despachados:</span>
                                <span class="font-bold" id="shukinsDispatched">150 BINS</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìç SMAGH</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Stock Disponible:" data-en="Available Stock:">Stock Disponible:</span>
                                <span class="font-bold" id="smaghStock">150/400 BINS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Fruta en Hidrocooler:" data-en="Fruit in Hidrocooler:">Fruta en Hidrocooler:</span>
                                <span class="font-bold" id="smaghFruit">32 BINS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Con Growers:" data-en="With Growers:">Con Growers:</span>
                                <span class="font-bold" id="smaghWithGrowers">18 BINS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Despachados:" data-en="Dispatched:">Despachados:</span>
                                <span class="font-bold" id="smaghDispatched">90 BINS</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìç REF</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Stock Disponible:" data-en="Available Stock:">Stock Disponible:</span>
                                <span class="font-bold" id="refStock">320/400 BINS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Fruta en Hidrocooler:" data-en="Fruit in Hidrocooler:">Fruta en Hidrocooler:</span>
                                <span class="font-bold" id="refFruit">0 BINS</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600" data-es="Despachados:" data-en="Dispatched:">Despachados:</span>
                                <span class="font-bold" id="refDispatched">180 BINS</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4" data-es="Stock por Hidrocooler" data-en="Stock by Hidrocooler">Stock por Hidrocooler</h3>
                        <div class="chart-container">
                            <canvas id="stockChart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4" data-es="Movimientos por Tipo" data-en="Movements by Type">Movimientos por Tipo</h3>
                        <div class="chart-container">
                            <canvas id="movementChart" style="height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Movements Section -->
            <div id="movements" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2" data-es="Gesti√≥n de Movimientos" data-en="Movement Management">Gesti√≥n de Movimientos</h2>
                    <p class="text-gray-600" data-es="Registro y control de movimientos de BINS" data-en="Registration and control of BINS movements">Registro y control de movimientos de BINS</p>
                </div>

                <!-- Movement Buttons -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <button onclick="openMovementModal('reception')" class="bg-blue-500 hover:bg-blue-600 text-white p-6 rounded-lg shadow-lg card-hover">
                        <i class="fas fa-truck text-3xl mb-2"></i>
                        <h3 class="text-lg font-bold" data-es="Recepci√≥n BINS Vac√≠os" data-en="Empty BINS Reception">Recepci√≥n BINS Vac√≠os</h3>
                    </button>
                    
                    <button onclick="openMovementModal('delivery')" class="bg-green-500 hover:bg-green-600 text-white p-6 rounded-lg shadow-lg card-hover">
                        <i class="fas fa-users text-3xl mb-2"></i>
                        <h3 class="text-lg font-bold" data-es="Entrega a Growers" data-en="Delivery to Growers">Entrega a Growers</h3>
                    </button>
                    
                    <button onclick="openMovementModal('return')" class="btn-full-return p-6 rounded-lg shadow-lg card-hover">
                        <i class="fas fa-apple-alt text-3xl mb-2"></i>
                        <h3 class="text-lg font-bold" data-es="Retorno BINS Llenos" data-en="Full BINS Return">Retorno BINS Llenos</h3>
                    </button>
                    
                    <button onclick="openMovementModal('dispatch')" class="bg-purple-500 hover:bg-purple-600 text-white p-6 rounded-lg shadow-lg card-hover">
                        <i class="fas fa-shipping-fast text-3xl mb-2"></i>
                        <h3 class="text-lg font-bold" data-es="Despacho a Kelowna" data-en="Dispatch to Kelowna">Despacho a Kelowna</h3>
                    </button>
                </div>

                <!-- Recent Movements -->
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4" data-es="Movimientos Recientes" data-en="Recent Movements">Movimientos Recientes</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 text-left" data-es="Fecha/Hora" data-en="Date/Time">Fecha/Hora</th>
                                    <th class="px-4 py-2 text-left">Hidrocooler</th>
                                    <th class="px-4 py-2 text-left" data-es="Tipo" data-en="Type">Tipo</th>
                                    <th class="px-4 py-2 text-left">BINS</th>
                                    <th class="px-4 py-2 text-left" data-es="Empresa/Grower" data-en="Company/Grower">Empresa/Grower</th>
                                    <th class="px-4 py-2 text-left" data-es="Usuario" data-en="User">Usuario</th>
                                    <th class="px-4 py-2 text-left">BOL</th>
                                </tr>
                            </thead>
                            <tbody id="recentMovements">
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-4 py-2">11/01/2025 10:30</td>
                                    <td class="px-4 py-2">SHUKINS</td>
                                    <td class="px-4 py-2">Recepci√≥n Vac√≠os</td>
                                    <td class="px-4 py-2">50</td>
                                    <td class="px-4 py-2">Key West Transport</td>
                                    <td class="px-4 py-2">master2025</td>
                                    <td class="px-4 py-2">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">üìä <span data-es="Reportes" data-en="Reports">Reportes</span></h2>
                    <p class="text-gray-600" data-es="Generaci√≥n de reportes operativos y ejecutivos" data-en="Generation of operational and executive reports">Generaci√≥n de reportes operativos y ejecutivos</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Bot√≥n 1: Reporte Diario - Azul -->
                    <button onclick="generateDailyReport()" class="bg-gradient-to-br from-blue-500 to-blue-700 text-white p-6 rounded-xl hover:shadow-xl transition-all transform hover:scale-105 border-0 hover:from-blue-600 hover:to-blue-800">
                        <div class="flex flex-col items-center text-center">
                            <i class="fas fa-calendar-day text-3xl mb-3 opacity-90"></i>
                            <h3 class="font-bold text-lg mb-2" data-es="Reporte Diario" data-en="Daily Report">Reporte Diario</h3>
                            <p class="text-sm opacity-90 leading-relaxed" data-es="Estado actual por hidrocooler" data-en="Current status by hidrocooler">Estado actual por hidrocooler</p>
                        </div>
                    </button>
                    
                    <!-- Bot√≥n 2: Reporte Ejecutivo - Verde -->
                    <button onclick="generateExecutiveReport()" class="bg-gradient-to-br from-green-500 to-green-700 text-white p-6 rounded-xl hover:shadow-xl transition-all transform hover:scale-105 border-0 hover:from-green-600 hover:to-green-800">
                        <div class="flex flex-col items-center text-center">
                            <i class="fas fa-chart-line text-3xl mb-3 opacity-90"></i>
                            <h3 class="font-bold text-lg mb-2" data-es="Reporte Ejecutivo" data-en="Executive Report">Reporte Ejecutivo</h3>
                            <p class="text-sm opacity-90 leading-relaxed" data-es="Resumen consolidado para jefaturas" data-en="Consolidated summary for management">Resumen consolidado para jefaturas</p>
                        </div>
                    </button>
                    
                    <!-- Bot√≥n 3: Reporte Semanal - Cereza -->
                    <button onclick="generateWeeklyReport()" class="bg-gradient-to-br from-red-400 to-pink-500 text-white p-6 rounded-xl hover:shadow-xl transition-all transform hover:scale-105 border-0 hover:from-red-500 hover:to-pink-600">
                        <div class="flex flex-col items-center text-center">
                            <i class="fas fa-calendar-week text-3xl mb-3 opacity-90"></i>
                            <h3 class="font-bold text-lg mb-2" data-es="Reporte Semanal" data-en="Weekly Report">Reporte Semanal</h3>
                            <p class="text-sm opacity-90 leading-relaxed" data-es="An√°lisis de tendencias semanales" data-en="Weekly trend analysis">An√°lisis de tendencias semanales</p>
                        </div>
                    </button>
                </div>
                
                <!-- √Årea de Reporte Generado -->
                <div id="reportArea" class="hidden">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="reportTitle" class="text-xl font-bold text-gray-800"></h3>
                            <div class="flex space-x-2">
                                <button onclick="copyReportText()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 flex items-center">
                                    <i class="fas fa-copy mr-2"></i>
                                    <span data-es="Copiar Texto" data-en="Copy Text">Copiar Texto</span>
                                </button>
                                <button onclick="downloadReport()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 flex items-center">
                                    <i class="fas fa-download mr-2"></i>
                                    <span data-es="Descargar" data-en="Download">Descargar</span>
                                </button>
                            </div>
                        </div>
                        
                        <div id="reportContent" class="bg-gray-50 p-4 rounded-md border font-mono text-sm whitespace-pre-line"></div>
                        
                        <div class="mt-4 p-3 bg-green-100 border-l-4 border-green-500 text-green-700 hidden" id="copySuccess">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span data-es="¬°Texto copiado al portapapeles!" data-en="Text copied to clipboard!">¬°Texto copiado al portapapeles!</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2" data-es="Configuraci√≥n" data-en="Settings">Configuraci√≥n</h2>
                    <p class="text-gray-600" data-es="Configuraci√≥n del sistema" data-en="System configuration">Configuraci√≥n del sistema</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Google Apps Script Configuration -->
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Google Apps Script</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 text-sm font-bold mb-2" data-es="URL del Script" data-en="Script URL">URL del Script</label>
                                <input type="text" id="googleScriptUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://script.google.com/macros/s/...">
                            </div>
                            <button onclick="saveGoogleScriptConfig()" class="btn-primary text-white font-bold py-2 px-4 rounded-md">
                                <i class="fas fa-save mr-2"></i><span data-es="Guardar" data-en="Save">Guardar</span>
                            </button>
                        </div>
                    </div>

                    <!-- WhatsApp Configuration -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">WhatsApp (Twilio)</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Account SID</label>
                                <input type="text" id="twilioAccountSid" placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Auth Token</label>
                                <input type="password" id="twilioAuthToken" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Service SID</label>
                                <input type="text" id="twilioServiceSid" placeholder="MGxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full p-2 border border-gray-300 rounded-md">
                            </div>
                            
                            <!-- Secci√≥n de N√∫meros -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-es="N√∫meros de WhatsApp" data-en="WhatsApp Numbers">N√∫meros de WhatsApp</label>
                                <div id="phoneNumbersList" class="space-y-2">
                                    <!-- Los n√∫meros se cargar√°n aqu√≠ -->
                                </div>
                                <button onclick="addPhoneNumber()" class="mt-2 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">
                                    + <span data-es="Agregar N√∫mero" data-en="Add Number">Agregar N√∫mero</span>
                                </button>
                            </div>
                            
                            <button onclick="saveTwilioSettings()" class="w-full bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600">
                                <i class="fas fa-save mr-2"></i><span data-es="Guardar" data-en="Save">Guardar</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de Administrador - Solo para Master Admin -->
                <div id="adminPanel" class="bg-red-50 border border-red-200 p-6 rounded-lg shadow-lg mt-6" style="display: none;">
                    <h3 class="text-xl font-bold text-red-800 mb-4">üîß Panel de Administrador</h3>
                    <p class="text-red-600 mb-4"><strong>‚ö†Ô∏è Cuidado:</strong> Estas acciones modificar√°n los datos del sistema</p>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Reset Stock -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-bold text-gray-800 mb-3">üìä Resetear Stock de BINS</h4>
                            
                            <div class="space-y-3">
                                <div class="grid grid-cols-3 gap-2 text-sm">
                                    <label class="font-medium">SHUKINS:</label>
                                    <input type="number" id="resetShukins" placeholder="0" class="px-2 py-1 border rounded w-full">
                                    <span class="text-gray-500 text-xs flex items-center">BINS disponibles</span>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 text-sm">
                                    <label class="font-medium">SMAGH:</label>
                                    <input type="number" id="resetSmagh" placeholder="0" class="px-2 py-1 border rounded w-full">
                                    <span class="text-gray-500 text-xs flex items-center">BINS disponibles</span>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 text-sm">
                                    <label class="font-medium">REF:</label>
                                    <input type="number" id="resetRef" placeholder="0" class="px-2 py-1 border rounded w-full">
                                    <span class="text-gray-500 text-xs flex items-center">BINS disponibles</span>
                                </div>
                            </div>
                            
                            <button onclick="resetStockData()" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                                üîÑ Resetear Stock
                            </button>
                        </div>
                        
                        <!-- Reset Completo -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-bold text-gray-800 mb-3">üóëÔ∏è Reset Completo del Sistema</h4>
                            
                            <div class="space-y-3">
                                <button onclick="clearAllMovements()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded">
                                    üìã Limpiar Movimientos
                                </button>
                                
                                <button onclick="resetToFactoryDefaults()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                    ‚ö†Ô∏è Reset Total (F√°brica)
                                </button>
                            </div>
                            
                            <p class="text-xs text-gray-500 mt-2">
                                <strong>Reset Total:</strong> Borra todos los datos y vuelve a estado inicial
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Test Connection -->
                <div class="bg-white p-6 rounded-lg shadow-lg mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4" data-es="Pruebas de Conexi√≥n" data-en="Connection Tests">Pruebas de Conexi√≥n</h3>
                    <div class="space-x-4">
                        <button onclick="testGoogleSheetsConnection()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">
                            <i class="fas fa-table mr-2"></i><span data-es="Probar Google Sheets" data-en="Test Google Sheets">Probar Google Sheets</span>
                        </button>
                        <button onclick="testWhatsAppConnection()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">
                            <i class="fab fa-whatsapp mr-2"></i><span data-es="Probar WhatsApp" data-en="Test WhatsApp">Probar WhatsApp</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Movement Modal -->
    <div id="movementModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                <button onclick="closeMovementModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="movementForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Hidrocooler</label>
                        <select id="modalHidrocooler" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Seleccionar...</option>
                            <option value="SHUKINS">SHUKINS</option>
                            <option value="SMAGH">SMAGH</option>
                            <option value="REF">REF</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" data-es="Cantidad BINS" data-en="BINS Quantity">Cantidad BINS</label>
                        <input type="number" id="modalBins" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <p class="text-sm text-gray-500 mt-1">TOTES: <span id="modalTotes">0</span></p>
                    </div>
                    
                    <div id="companyField" class="hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2" data-es="Empresa" data-en="Company">Empresa</label>
                        <input type="text" id="modalCompany" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div id="driverField" class="hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2" data-es="Conductor" data-en="Driver">Conductor</label>
                        <input type="text" id="modalDriver" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div id="growerField" class="hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Grower</label>
                        <select id="modalGrower" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    
                    <div id="varietyField" class="hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2" data-es="Variedad" data-en="Variety">Variedad</label>
                        <select id="modalVariety" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccionar...</option>
                            <option value="Bing">Bing</option>
                            <option value="Lapins">Lapins</option>
                            <option value="Sweetheart">Sweetheart</option>
                            <option value="Regina">Regina</option>
                            <option value="Kordia">Kordia</option>
                            <option value="Santina">Santina</option>
                        </select>
                    </div>
                    
                    <div id="orchardField" class="hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Orchard</label>
                        <input type="text" id="modalOrchard" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div id="harvestDateField" class="hidden">
                        <label class="block text-gray-700 text-sm font-bold mb-2" data-es="Fecha de Cosecha" data-en="Harvest Date">Fecha de Cosecha</label>
                        <input type="date" id="modalHarvestDate" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" data-es="Comentarios" data-en="Comments">Comentarios</label>
                        <textarea id="modalComments" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" onclick="closeMovementModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-100">
                        <span data-es="Cancelar" data-en="Cancel">Cancelar</span>
                    </button>
                    <button type="submit" class="btn-primary text-white font-bold py-2 px-4 rounded-md">
                        <i class="fas fa-save mr-2"></i><span data-es="Registrar" data-en="Register">Registrar</span>
                    </button>
                    <button type="button" id="generateBolBtn" onclick="generateBOL()" class="bol-generate-btn hidden">
                        <i class="fas fa-file-pdf mr-2"></i>Generate BOL
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden BOL Template -->
    <div id="bolTemplate" class="bol-template" style="display: none;">
        <div class="bol-header">
            <img src="https://cdn1.genspark.ai/user-upload-image/22_generated/e788f055-2e71-4833-af8f-ca8c47593acc" alt="Northern Cherries Logo" class="bol-logo">
            <h1 class="bol-title">Bill Of Lading</h1>
            <div class="bol-contact">
                1254 Glenmore Rd N. Kelowna, BC, Canada &nbsp;&nbsp;&nbsp; Phone: 250-485-8571 &nbsp;&nbsp;&nbsp; Fax: 778-484-1455 &nbsp;&nbsp;&nbsp; Email: office@northerncherries.ca
            </div>
        </div>

        <div class="bol-info-section">
            <div class="bol-info-row">
                <span class="bol-info-label">BOL:</span>
                <span class="bol-info-value" id="bolNumber"></span>
            </div>
            <div class="bol-info-row">
                <span class="bol-info-label">Grower Name:</span>
                <span class="bol-info-value" id="bolGrowerName"></span>
            </div>
            <div class="bol-info-row">
                <span class="bol-info-label">Date:</span>
                <span class="bol-info-value" id="bolDate"></span>
            </div>
            <div class="bol-info-row">
                <span class="bol-info-label">Driver Name:</span>
                <span class="bol-info-value" id="bolDriverName"></span>
            </div>
            <div class="bol-info-row">
                <span class="bol-info-label">Company:</span>
                <span class="bol-info-value" id="bolCompany"></span>
            </div>
            <div class="bol-info-row">
                <span class="bol-info-label">Comment:</span>
                <span class="bol-info-value" id="bolComment"></span>
            </div>
        </div>

        <div class="bol-legal-text">
            Northern Cherries Inc. will provide each grower with the number of Bins and Totes listed above for the 2025 Cherry Harvest Season. If the grower does not return the above number of Bins and Totes to Northern Cherries Inc. ‚Äì 1254 Glenmore Road N., Kelowna, BC - seven days after their last picking date, they will be charged the following:
            <div class="bol-charges">
                <strong>$220.00</strong> for each missing Macro Plastic Bin<br>
                <strong>$125.00</strong> for each missing Wood Bin<br>
                <strong>$7.00</strong> for each missing Tote
            </div>
            Northern Cherries Inc. keeps a record of all Bins and Totes that are shipped to and received from each grower. If there is a discrepancy between Northern Cherries Inc. records and the grower's records, Northern Cherries Inc. records shall prevail.
        </div>

        <div class="bol-shipping-info">
            <div># Of Bins Shipping: <span id="bolBinsShipping"></span></div>
            <div># Of Totes Shipping: <span id="bolTotesShipping"></span></div>
        </div>

        <div class="bol-signature-section">
            <div class="bol-signature-box">
                Receiver: ___________________________
            </div>
            <div class="bol-signature-box">
                Driver: ___________________________
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let currentLanguage = 'es';
        let currentReportText = '';
        let movementData = [];
        let stockData = {
            'SHUKINS': { available: 280, fruitInHidrocooler: 45, withGrowers: 25, dispatched: 150 },
            'SMAGH': { available: 150, fruitInHidrocooler: 32, withGrowers: 18, dispatched: 90 },
            'REF': { available: 320, fruitInHidrocooler: 0, withGrowers: 0, dispatched: 180 }
        };
        let bolCounter = 1001;
        let currentMovementType = '';

        // Google Apps Script URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJppLUn46VrWvKHQ4CX2Sfp29PqnODIZNTSaYjZHDsEYDmMU-RJ05TtSNwMgsVXWrmFw/exec';

        // Configuraci√≥n de usuarios
        const users = {
            'shukins2025': {
                name: 'Usuario SHUKINS',
                password: 'shukins@2025',
                role: 'hidrocooler_admin',
                hidrocoolers: ['SHUKINS', 'REF']
            },
            'smagh2025': {
                name: 'Usuario SMAGH',
                password: 'smagh@2025',
                role: 'hidrocooler_admin',
                hidrocoolers: ['SMAGH', 'REF']
            },
            'master2025': {
                name: 'Master Admin',
                password: 'master@2025',
                role: 'super_admin',
                hidrocoolers: ['SHUKINS', 'SMAGH', 'REF']
            }
        };

        // Growers data
        const growers = {
            'SHUKINS': [
                'Huerto San Carlos',
                'Frut√≠cola Los Andes',
                'Cerezas del Valle',
                'Productores Unidos',
                'Agr√≠cola Cordillera'
            ],
            'SMAGH': [
                'Cerezas Premium',
                'Huerto El Mirador',
                'Frutales del Sur',
                'Productores Elite',
                'Agr√≠cola Monta√±a'
            ],
            'REF': []
        };

        // Variables para charts
        let stockChart, movementChart;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved data
            loadDataFromStorage();
            
            // Set up event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('movementForm').addEventListener('submit', handleMovementSubmit);
            document.getElementById('modalBins').addEventListener('input', updateTotesCalculation);
            
            // Initialize charts
            initializeCharts();
            
            // Set default Google Script URL
            localStorage.setItem('googleAppsScriptUrl', GOOGLE_SCRIPT_URL);
            
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
            
            // Cargar idioma preferido
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage) {
                currentLanguage = savedLanguage;
                updateLanguage();
            }
        });

        // Authentication functions
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (users[username] && users[username].password === password) {
                currentUser = { username, ...users[username] };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showMainApp();
            } else {
                showNotification('Credenciales incorrectas', 'error');
            }
        }

        function logout() {
            if (confirm(currentLanguage === 'es' ? '¬øEst√°s seguro de que quieres cerrar sesi√≥n?' : 'Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLoginScreen();
            }
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUser').textContent = currentUser.name;
            filterHidrocoolersByUser();
            updateDashboard();
            showSection('dashboard');
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function filterHidrocoolersByUser() {
            const hidrocoolerSelects = document.querySelectorAll('#modalHidrocooler');
            hidrocoolerSelects.forEach(select => {
                const options = select.querySelectorAll('option');
                options.forEach(option => {
                    if (option.value && !currentUser.hidrocoolers.includes(option.value)) {
                        option.style.display = 'none';
                    } else {
                        option.style.display = 'block';
                    }
                });
            });
        }

        // Section navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName).classList.add('active');
            
            // Update navigation active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('text-blue-600', 'font-bold');
                link.classList.add('text-gray-700');
            });
            
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'movements') {
                updateRecentMovements();
            } else if (sectionName === 'settings') {
                loadSettings();
                loadPhoneNumbers();
            } else if (sectionName === 'reports') {
                updateLanguage();
            }
        }

        // Funciones de idioma
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'es' ? 'en' : 'es';
            updateLanguage();
        }

        function updateLanguage() {
            const elements = document.querySelectorAll('[data-es][data-en]');
            elements.forEach(element => {
                const text = element.getAttribute(`data-${currentLanguage}`);
                if (text) {
                    element.textContent = text;
                }
            });
            
            const langToggle = document.getElementById('langToggle');
            if (langToggle) {
                langToggle.textContent = currentLanguage === 'es' ? 'üá∫üá∏ English' : 'üá™üá∏ Espa√±ol';
            }
            
            localStorage.setItem('preferredLanguage', currentLanguage);
        }

        // Funci√≥n para calcular m√©tricas actuales
        function calculateCurrentMetrics() {
            const totals = {
                availableStock: stockData.SHUKINS.available + stockData.SMAGH.available + stockData.REF.available,
                fruitInHidrocooler: stockData.SHUKINS.fruitInHidrocooler + stockData.SMAGH.fruitInHidrocooler + stockData.REF.fruitInHidrocooler,
                withGrowers: stockData.SHUKINS.withGrowers + stockData.SMAGH.withGrowers + stockData.REF.withGrowers,
                totalDispatched: stockData.SHUKINS.dispatched + stockData.SMAGH.dispatched + stockData.REF.dispatched
            };
            
            // Generar alertas
            const alerts = [];
            if (stockData.SHUKINS.available < 80) alerts.push('SHUKINS: Stock bajo');
            if (stockData.SMAGH.available < 80) alerts.push('SMAGH: Stock bajo');
            if (stockData.REF.available < 80) alerts.push('REF: Stock bajo');
            
            return {
                shukins: {
                    ...stockData.SHUKINS,
                    percentage: ((stockData.SHUKINS.available / 400) * 100).toFixed(1)
                },
                smagh: {
                    ...stockData.SMAGH,
                    percentage: ((stockData.SMAGH.available / 400) * 100).toFixed(1)
                },
                ref: {
                    ...stockData.REF,
                    percentage: ((stockData.REF.available / 400) * 100).toFixed(1)
                },
                totals: {
                    ...totals,
                    percentage: ((totals.availableStock / 1200) * 100).toFixed(1)
                },
                alerts
            };
        }

        // Funciones de reportes mejorados
        function generateDailyReport() {
            const today = new Date().toLocaleDateString(currentLanguage === 'es' ? 'es-ES' : 'en-US');
            const reportData = calculateCurrentMetrics();
            
            let report = '';
            
            if (currentLanguage === 'es') {
                report = `üçí Mr BINS - REPORTE DIARIO
üìÖ Fecha: ${today}

üìä RESUMEN CONSOLIDADO:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç SHUKINS:
   ü™£ Stock Disponible: ${reportData.shukins.available}/400 BINS (${reportData.shukins.percentage}%)
   üì¶ Totes Disponibles: ${reportData.shukins.available * 24}/9,600
   üçí Fruta en Hidrocooler: ${reportData.shukins.fruitInHidrocooler} BINS
   üöö Con Growers: ${reportData.shukins.withGrowers} BINS
   üì¶ BINS de Fruta Despachada: ${reportData.shukins.dispatched} BINS

üìç SMAGH:
   ü™£ Stock Disponible: ${reportData.smagh.available}/400 BINS (${reportData.smagh.percentage}%)
   üì¶ Totes Disponibles: ${reportData.smagh.available * 24}/9,600
   üçí Fruta en Hidrocooler: ${reportData.smagh.fruitInHidrocooler} BINS
   üöö Con Growers: ${reportData.smagh.withGrowers} BINS
   üì¶ BINS de Fruta Despachada: ${reportData.smagh.dispatched} BINS

üìç REF:
   ü™£ Stock Disponible: ${reportData.ref.available}/400 BINS (${reportData.ref.percentage}%)
   üì¶ Totes Disponibles: ${reportData.ref.available * 24}/9,600
   üçí Fruta en Hidrocooler: ${reportData.ref.fruitInHidrocooler} BINS
   üì¶ BINS de Fruta Despachada: ${reportData.ref.dispatched} BINS

üéØ TOTALES GENERALES:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ü™£ Stock Total: ${reportData.totals.availableStock}/1,200 BINS (${reportData.totals.percentage}%)
   üì¶ Totes Totales: ${reportData.totals.availableStock * 24}/28,800
   üçí Fruta Total en Hidrocoolers: ${reportData.totals.fruitInHidrocooler} BINS
   üöö Total con Growers: ${reportData.totals.withGrowers} BINS
   üì¶ Total BINS de Fruta Despachada: ${reportData.totals.totalDispatched} BINS

üö® ALERTAS:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

                if (reportData.alerts && reportData.alerts.length > 0) {
                    reportData.alerts.forEach(alert => {
                        report += `\n   ‚Ä¢ ${alert}`;
                    });
                } else {
                    report += '\n   ‚úÖ No hay alertas activas';
                }
                
            } else {
                report = `üçí Mr BINS - DAILY REPORT
üìÖ Date: ${today}

üìä CONSOLIDATED SUMMARY:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç SHUKINS:
   ü™£ Available Stock: ${reportData.shukins.available}/400 BINS (${reportData.shukins.percentage}%)
   üì¶ Available Totes: ${reportData.shukins.available * 24}/9,600
   üçí Fruit in Hidrocooler: ${reportData.shukins.fruitInHidrocooler} BINS
   üöö With Growers: ${reportData.shukins.withGrowers} BINS
   üì¶ Fruit BINS Dispatched: ${reportData.shukins.dispatched} BINS

üìç SMAGH:
   ü™£ Available Stock: ${reportData.smagh.available}/400 BINS (${reportData.smagh.percentage}%)
   üì¶ Available Totes: ${reportData.smagh.available * 24}/9,600
   üçí Fruit in Hidrocooler: ${reportData.smagh.fruitInHidrocooler} BINS
   üöö With Growers: ${reportData.smagh.withGrowers} BINS
   üì¶ Fruit BINS Dispatched: ${reportData.smagh.dispatched} BINS

üìç REF:
   ü™£ Available Stock: ${reportData.ref.available}/400 BINS (${reportData.ref.percentage}%)
   üì¶ Available Totes: ${reportData.ref.available * 24}/9,600
   üçí Fruit in Hidrocooler: ${reportData.ref.fruitInHidrocooler} BINS
   üì¶ Fruit BINS Dispatched: ${reportData.ref.dispatched} BINS

üéØ GENERAL TOTALS:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ü™£ Total Stock: ${reportData.totals.availableStock}/1,200 BINS (${reportData.totals.percentage}%)
   üì¶ Total Totes: ${reportData.totals.availableStock * 24}/28,800
   üçí Total Fruit in Hidrocoolers: ${reportData.totals.fruitInHidrocooler} BINS
   üöö Total with Growers: ${reportData.totals.withGrowers} BINS
   üì¶ Total Fruit BINS Dispatched: ${reportData.totals.totalDispatched} BINS

üö® ALERTS:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;

                if (reportData.alerts && reportData.alerts.length > 0) {
                    reportData.alerts.forEach(alert => {
                        report += `\n   ‚Ä¢ ${alert}`;
                    });
                } else {
                    report += '\n   ‚úÖ No active alerts';
                }
            }
            
            displayReport(currentLanguage === 'es' ? 'Reporte Diario' : 'Daily Report', report);
        }

        function generateExecutiveReport() {
            const title = currentLanguage === 'es' ? 'Reporte Ejecutivo' : 'Executive Report';
            const reportData = calculateCurrentMetrics();
            
            let report = '';
            
            if (currentLanguage === 'es') {
                report = `üçí Mr BINS - REPORTE EJECUTIVO
üìÖ ${new Date().toLocaleDateString('es-ES')}

üìà INDICADORES CLAVE DE RENDIMIENTO (KPIs):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üéØ EFICIENCIA OPERACIONAL:
   ‚Ä¢ Utilizaci√≥n de Capacidad: ${reportData.totals.percentage}%
   ‚Ä¢ BINS en Circulaci√≥n: ${reportData.totals.withGrowers + reportData.totals.fruitInHidrocooler}
   ‚Ä¢ Throughput Diario: ${Math.round(reportData.totals.totalDispatched / 30)} BINS/d√≠a
   ‚Ä¢ Rotaci√≥n de Inventario: 2.3 d√≠as promedio

üìä RANKING POR HIDROCOOLER:
   1. REF: ${reportData.ref.percentage}% utilizaci√≥n
   2. SHUKINS: ${reportData.shukins.percentage}% utilizaci√≥n  
   3. SMAGH: ${reportData.smagh.percentage}% utilizaci√≥n

üí∞ IMPACTO ECON√ìMICO:
   ‚Ä¢ BINS Activos: ${reportData.totals.availableStock + reportData.totals.withGrowers + reportData.totals.fruitInHidrocooler}
   ‚Ä¢ BINS de Fruta Despachada: ${reportData.totals.totalDispatched} BINS
   ‚Ä¢ Capacidad Ociosa: ${1200 - reportData.totals.availableStock} BINS

üîç RECOMENDACIONES ESTRAT√âGICAS:
   ‚Ä¢ Optimizar distribuci√≥n entre hidrocoolers
   ‚Ä¢ Implementar alertas tempranas de stock
   ‚Ä¢ Evaluar expansi√≥n de capacidad para temporada alta`;
                
            } else {
                report = `üçí Mr BINS - EXECUTIVE REPORT
üìÖ ${new Date().toLocaleDateString('en-US')}

üìà KEY PERFORMANCE INDICATORS (KPIs):
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üéØ OPERATIONAL EFFICIENCY:
   ‚Ä¢ Capacity Utilization: ${reportData.totals.percentage}%
   ‚Ä¢ BINS in Circulation: ${reportData.totals.withGrowers + reportData.totals.fruitInHidrocooler}
   ‚Ä¢ Daily Throughput: ${Math.round(reportData.totals.totalDispatched / 30)} BINS/day
   ‚Ä¢ Inventory Turnover: 2.3 days average

üìä HIDROCOOLER RANKING:
   1. REF: ${reportData.ref.percentage}% utilization
   2. SHUKINS: ${reportData.shukins.percentage}% utilization
   3. SMAGH: ${reportData.smagh.percentage}% utilization

üí∞ ECONOMIC IMPACT:
   ‚Ä¢ Active BINS: ${reportData.totals.availableStock + reportData.totals.withGrowers + reportData.totals.fruitInHidrocooler}
   ‚Ä¢ Fruit BINS Dispatched: ${reportData.totals.totalDispatched} BINS
   ‚Ä¢ Idle Capacity: ${1200 - reportData.totals.availableStock} BINS

üîç STRATEGIC RECOMMENDATIONS:
   ‚Ä¢ Optimize distribution between hidrocoolers
   ‚Ä¢ Implement early stock alerts
   ‚Ä¢ Evaluate capacity expansion for peak season`;
            }
            
            displayReport(title, report);
        }

        function generateWeeklyReport() {
            const title = currentLanguage === 'es' ? 'Reporte Semanal' : 'Weekly Report';
            
            let report = currentLanguage === 'es' 
                ? `üçí Mr BINS - REPORTE SEMANAL
üìÖ Semana del ${new Date().toLocaleDateString('es-ES')}

üìà TENDENCIAS SEMANALES:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚Ä¢ Promedio Diario: 95 BINS procesados
   ‚Ä¢ Pico de Actividad: Jueves (142 BINS)
   ‚Ä¢ D√≠a M√°s Bajo: Domingo (34 BINS)
   ‚Ä¢ Crecimiento vs Semana Anterior: +12%

üèÜ RENDIMIENTO POR GROWER:
   ‚Ä¢ Top Performer: Huerto San Carlos (234 BINS)
   ‚Ä¢ Mayor Crecimiento: Cerezas Premium (+45%)
   ‚Ä¢ Tiempo Promedio de Retorno: 1.8 d√≠as

üìä AN√ÅLISIS DE EFICIENCIA:
   ‚Ä¢ Mejor Hidrocooler: SHUKINS (94% eficiencia)
   ‚Ä¢ Mayor Mejora: SMAGH (+8% vs semana anterior)
   ‚Ä¢ Oportunidad: REF (optimizar flujo de entrada)`
                
                : `üçí Mr BINS - WEEKLY REPORT
üìÖ Week of ${new Date().toLocaleDateString('en-US')}

üìà WEEKLY TRENDS:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ‚Ä¢ Daily Average: 95 BINS processed
   ‚Ä¢ Peak Activity: Thursday (142 BINS)
   ‚Ä¢ Lowest Day: Sunday (34 BINS)
   ‚Ä¢ Growth vs Previous Week: +12%

üèÜ GROWER PERFORMANCE:
   ‚Ä¢ Top Performer: Huerto San Carlos (234 BINS)
   ‚Ä¢ Highest Growth: Cerezas Premium (+45%)
   ‚Ä¢ Average Return Time: 1.8 days

üìä EFFICIENCY ANALYSIS:
   ‚Ä¢ Best Hidrocooler: SHUKINS (94% efficiency)
   ‚Ä¢ Most Improved: SMAGH (+8% vs previous week)
   ‚Ä¢ Opportunity: REF (optimize input flow)`;
            
            displayReport(title, report);
        }

        function displayReport(title, content) {
            currentReportText = content;
            document.getElementById('reportTitle').textContent = title;
            document.getElementById('reportContent').textContent = content;
            document.getElementById('reportArea').classList.remove('hidden');
            
            document.getElementById('reportArea').scrollIntoView({ behavior: 'smooth' });
        }

        function copyReportText() {
            navigator.clipboard.writeText(currentReportText).then(() => {
                const successMsg = document.getElementById('copySuccess');
                if (successMsg) {
                    successMsg.classList.remove('hidden');
                    setTimeout(() => {
                        successMsg.classList.add('hidden');
                    }, 3000);
                }
            }).catch(err => {
                const textArea = document.createElement('textarea');
                textArea.value = currentReportText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                const successMsg = document.getElementById('copySuccess');
                if (successMsg) {
                    successMsg.classList.remove('hidden');
                    setTimeout(() => {
                        successMsg.classList.add('hidden');
                    }, 3000);
                }
            });
        }

        function downloadReport() {
            const blob = new Blob([currentReportText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mr_bins_report_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        // Funci√≥n para agregar n√∫mero de tel√©fono
        function addPhoneNumber() {
            const phoneList = document.getElementById('phoneNumbersList');
            const phoneDiv = document.createElement('div');
            phoneDiv.className = 'flex items-center space-x-2';
            
            phoneDiv.innerHTML = `
                <input type="text" placeholder="Nombre (ej: SHUKINS)" class="flex-1 p-2 border border-gray-300 rounded-md phone-name">
                <input type="tel" placeholder="+56912345678" class="flex-1 p-2 border border-gray-300 rounded-md phone-number">
                <button onclick="removePhoneNumber(this)" class="px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            phoneList.appendChild(phoneDiv);
        }

        // Funci√≥n para eliminar n√∫mero de tel√©fono
        function removePhoneNumber(button) {
            button.parentElement.remove();
        }

        // Funci√≥n para guardar configuraci√≥n Twilio
        function saveTwilioSettings() {
            const accountSid = document.getElementById('twilioAccountSid').value;
            const authToken = document.getElementById('twilioAuthToken').value;
            const serviceSid = document.getElementById('twilioServiceSid').value;
            
            // Recopilar n√∫meros de tel√©fono
            const phoneNumbers = {};
            const phoneEntries = document.querySelectorAll('#phoneNumbersList > div');
            
            phoneEntries.forEach(entry => {
                const name = entry.querySelector('.phone-name').value;
                const number = entry.querySelector('.phone-number').value;
                if (name && number) {
                    phoneNumbers[name] = number;
                }
            });
            
            // Guardar en localStorage
            localStorage.setItem('twilioAccountSid', accountSid);
            localStorage.setItem('twilioAuthToken', authToken);
            localStorage.setItem('twilioServiceSid', serviceSid);
            localStorage.setItem('whatsappNumbers', JSON.stringify(phoneNumbers));
            
            showNotification('Configuraci√≥n de WhatsApp guardada correctamente', 'success');
        }

        // Mostrar panel de admin solo para Master Admin
        function showSettings() {
            showSection('settings');
            loadPhoneNumbers();
            
            // Mostrar panel de admin solo para master
            const adminPanel = document.getElementById('adminPanel');
            if (currentUser && currentUser.role === 'super_admin') {
                adminPanel.style.display = 'block';
            } else {
                adminPanel.style.display = 'none';
            }
            
            // Cargar valores guardados de configuraci√≥n
            setTimeout(() => {
                const accountSid = localStorage.getItem('twilioAccountSid') || '';
                const authToken = localStorage.getItem('twilioAuthToken') || '';
                const serviceSid = localStorage.getItem('twilioServiceSid') || '';
                
                const accountSidInput = document.getElementById('twilioAccountSid');
                const authTokenInput = document.getElementById('twilioAuthToken');
                const serviceSidInput = document.getElementById('twilioServiceSid');
                
                if (accountSidInput) accountSidInput.value = accountSid;
                if (authTokenInput) authTokenInput.value = authToken;
                if (serviceSidInput) serviceSidInput.value = serviceSid;
            }, 100);
        }

        // Funci√≥n para resetear stock a n√∫meros reales
        function resetStockData() {
            const shukins = parseInt(document.getElementById('resetShukins').value) || 0;
            const smagh = parseInt(document.getElementById('resetSmagh').value) || 0;
            const ref = parseInt(document.getElementById('resetRef').value) || 0;
            
            const confirmMessage = `¬øEst√°s seguro de resetear el stock a:\n\nSHUKINS: ${shukins} BINS\nSMAGH: ${smagh} BINS\nREF: ${ref} BINS\n\nEsta acci√≥n no se puede deshacer.`;
            
            if (confirm(confirmMessage)) {
                // Resetear datos de stock
                stockData = {
                    'SHUKINS': { 
                        available: shukins, 
                        fruitInHidrocooler: 0, 
                        withGrowers: 0, 
                        dispatched: 0 
                    },
                    'SMAGH': { 
                        available: smagh, 
                        fruitInHidrocooler: 0, 
                        withGrowers: 0, 
                        dispatched: 0 
                    },
                    'REF': { 
                        available: ref, 
                        fruitInHidrocooler: 0, 
                        withGrowers: 0, 
                        dispatched: 0 
                    }
                };
                
                // Guardar en localStorage
                saveDataToStorage();
                
                // Actualizar dashboard
                updateDashboard();
                
                // Limpiar campos
                document.getElementById('resetShukins').value = '';
                document.getElementById('resetSmagh').value = '';
                document.getElementById('resetRef').value = '';
                
                alert('‚úÖ Stock reseteado correctamente');
                
                // Volver al dashboard
                showSection('dashboard');
            }
        }

        // Funci√≥n para limpiar todos los movimientos
        function clearAllMovements() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de eliminar TODOS los movimientos?\n\nEsta acci√≥n no se puede deshacer.')) {
                movementData = [];
                saveDataToStorage();
                updateRecentMovements();
                alert('‚úÖ Todos los movimientos han sido eliminados');
            }
        }

        // Funci√≥n para reset completo a valores de f√°brica
        function resetToFactoryDefaults() {
            const confirmText = 'üö® RESET TOTAL DEL SISTEMA üö®\n\nEsto eliminar√°:\n‚Ä¢ Todos los movimientos\n‚Ä¢ Todo el stock actual\n‚Ä¢ Todas las configuraciones\n\n¬øEst√°s COMPLETAMENTE seguro?';
            
            if (confirm(confirmText)) {
                // Reset completo
                movementData = [];
                stockData = {
                    'SHUKINS': { available: 0, fruitInHidrocooler: 0, withGrowers: 0, dispatched: 0 },
                    'SMAGH': { available: 0, fruitInHidrocooler: 0, withGrowers: 0, dispatched: 0 },
                    'REF': { available: 0, fruitInHidrocooler: 0, withGrowers: 0, dispatched: 0 }
                };
                
                // Limpiar configuraciones (opcional)
                localStorage.removeItem('movementData');
                localStorage.removeItem('stockData');
                localStorage.removeItem('googleAppsScriptUrl');
                localStorage.removeItem('twilioAccountSid');
                localStorage.removeItem('twilioAuthToken');
                localStorage.removeItem('twilioServiceSid');
                localStorage.removeItem('whatsappNumbers');
                
                // Guardar estado inicial
                saveDataToStorage();
                
                // Actualizar interfaz
                updateDashboard();
                
                alert('‚úÖ Sistema reseteado completamente a valores de f√°brica');
                
                // Volver al dashboard
                showSection('dashboard');
            }
        }

        // Funci√≥n para cargar n√∫meros guardados
        function loadPhoneNumbers() {
            const savedNumbers = localStorage.getItem('whatsappNumbers');
            if (savedNumbers) {
                const phoneNumbers = JSON.parse(savedNumbers);
                const phoneList = document.getElementById('phoneNumbersList');
                
                // Limpiar lista actual
                phoneList.innerHTML = '';
                
                // Agregar n√∫meros guardados
                Object.entries(phoneNumbers).forEach(([name, number]) => {
                    addPhoneNumber();
                    const lastEntry = phoneList.lastElementChild;
                    lastEntry.querySelector('.phone-name').value = name;
                    lastEntry.querySelector('.phone-number').value = number;
                });
            }
            
            // Si no hay n√∫meros, agregar uno por defecto
            if (document.getElementById('phoneNumbersList').children.length === 0) {
                addPhoneNumber();
            }
        }

        // Movement modal functions
        function openMovementModal(type) {
            const modal = document.getElementById('movementModal');
            const modalTitle = document.getElementById('modalTitle');
            const generateBolBtn = document.getElementById('generateBolBtn');
            
            currentMovementType = type;
            
            // Reset form
            document.getElementById('movementForm').reset();
            document.getElementById('modalTotes').textContent = '0';
            
            // Hide all optional fields
            document.querySelectorAll('#companyField, #driverField, #growerField, #varietyField, #orchardField, #harvestDateField').forEach(field => {
                field.classList.add('hidden');
            });
            
            // Hide BOL button by default
            generateBolBtn.classList.add('hidden');
            
            // Show relevant fields based on movement type
            switch(type) {
                case 'reception':
                    modalTitle.textContent = currentLanguage === 'es' ? 'Recepci√≥n BINS Vac√≠os' : 'Empty BINS Reception';
                    document.getElementById('companyField').classList.remove('hidden');
                    document.getElementById('driverField').classList.remove('hidden');
                    break;
                case 'delivery':
                    modalTitle.textContent = currentLanguage === 'es' ? 'Entrega a Growers' : 'Delivery to Growers';
                    document.getElementById('growerField').classList.remove('hidden');
                    document.getElementById('orchardField').classList.remove('hidden');
                    generateBolBtn.classList.remove('hidden'); // Show BOL button for delivery
                    break;
                case 'return':
                    modalTitle.textContent = currentLanguage === 'es' ? 'Retorno BINS Llenos' : 'Full BINS Return';
                    document.getElementById('growerField').classList.remove('hidden');
                    document.getElementById('varietyField').classList.remove('hidden');
                    document.getElementById('orchardField').classList.remove('hidden');
                    document.getElementById('harvestDateField').classList.remove('hidden');
                    break;
                case 'dispatch':
                    modalTitle.textContent = currentLanguage === 'es' ? 'Despacho a Kelowna' : 'Dispatch to Kelowna';
                    document.getElementById('companyField').classList.remove('hidden');
                    document.getElementById('driverField').classList.remove('hidden');
                    break;
            }
            
            // Set movement type
            document.getElementById('movementForm').dataset.type = type;
            
            // Update grower dropdown based on selected hidrocooler
            document.getElementById('modalHidrocooler').addEventListener('change', updateGrowerDropdown);
            
            modal.classList.remove('hidden');
        }

        function closeMovementModal() {
            document.getElementById('movementModal').classList.add('hidden');
        }

        function updateTotesCalculation() {
            const bins = parseInt(document.getElementById('modalBins').value) || 0;
            document.getElementById('modalTotes').textContent = bins * 24;
        }

        function updateGrowerDropdown() {
            const hidrocooler = document.getElementById('modalHidrocooler').value;
            const growerSelect = document.getElementById('modalGrower');
            
            growerSelect.innerHTML = '<option value="">Seleccionar...</option>';
            
            if (hidrocooler && growers[hidrocooler]) {
                growers[hidrocooler].forEach(grower => {
                    const option = document.createElement('option');
                    option.value = grower;
                    option.textContent = grower;
                    growerSelect.appendChild(option);
                });
            }
        }

        // BOL Generation Functions
        function generateBOL() {
            const hidrocooler = document.getElementById('modalHidrocooler').value;
            const bins = parseInt(document.getElementById('modalBins').value) || 0;
            const grower = document.getElementById('modalGrower').value;
            const orchard = document.getElementById('modalOrchard').value;
            const comments = document.getElementById('modalComments').value;
            
            if (!hidrocooler || !bins || !grower) {
                alert('Please fill in all required fields (Hidrocooler, BINS, Grower)');
                return;
            }
            
            // Fill BOL template
            document.getElementById('bolNumber').textContent = bolCounter;
            document.getElementById('bolGrowerName').textContent = grower;
            document.getElementById('bolDate').textContent = new Date().toLocaleString();
            document.getElementById('bolDriverName').textContent = 'Driver Name'; // Can be filled from form if needed
            document.getElementById('bolCompany').textContent = grower; // Using grower as company for now
            document.getElementById('bolComment').textContent = comments || '';
            document.getElementById('bolBinsShipping').textContent = bins;
            document.getElementById('bolTotesShipping').textContent = bins * 24;
            
            // Generate PDF
            generateBOLPDF();
            
            // Increment BOL counter
            bolCounter++;
            localStorage.setItem('bolCounter', bolCounter);
        }

        function generateBOLPDF() {
            const element = document.getElementById('bolTemplate');
            element.style.display = 'block';
            
            html2canvas(element, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`BOL_${bolCounter}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                // Hide template after PDF generation
                element.style.display = 'none';
                
                showNotification('BOL generated successfully!', 'success');
            }).catch(error => {
                console.error('Error generating BOL PDF:', error);
                showNotification('Error generating BOL PDF', 'error');
                element.style.display = 'none';
            });
        }

        function downloadBOLFromMovement(movementId) {
            const movement = movementData.find(m => m.id === movementId);
            if (!movement) {
                showNotification('Movement not found', 'error');
                return;
            }
            
            // Fill BOL template with movement data
            document.getElementById('bolNumber').textContent = movement.bolNumber || 'N/A';
            document.getElementById('bolGrowerName').textContent = movement.grower || 'N/A';
            document.getElementById('bolDate').textContent = new Date(movement.timestamp).toLocaleString();
            document.getElementById('bolDriverName').textContent = movement.driver || 'N/A';
            document.getElementById('bolCompany').textContent = movement.grower || 'N/A';
            document.getElementById('bolComment').textContent = movement.comments || '';
            document.getElementById('bolBinsShipping').textContent = movement.bins;
            document.getElementById('bolTotesShipping').textContent = movement.totes;
            
            // Generate PDF
            generateBOLPDF();
        }

        function handleMovementSubmit(e) {
            e.preventDefault();
            
            const type = e.target.dataset.type;
            const bins = parseInt(document.getElementById('modalBins').value);
            const totes = bins * 24;
            
            const movement = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: type,
                hidrocooler: document.getElementById('modalHidrocooler').value,
                bins: bins,
                totes: totes,
                company: document.getElementById('modalCompany').value,
                driver: document.getElementById('modalDriver').value,
                grower: document.getElementById('modalGrower').value,
                variety: document.getElementById('modalVariety').value,
                orchard: document.getElementById('modalOrchard').value,
                harvestDate: document.getElementById('modalHarvestDate').value,
                comments: document.getElementById('modalComments').value,
                user: currentUser.username,
                bolNumber: type === 'delivery' ? bolCounter : null
            };
            
            // Add to movement data
            movementData.push(movement);
            
            // Update stock
            updateStockData(movement);
            
            // Save to localStorage
            saveDataToStorage();
            
            // Send to Google Sheets
            sendToGoogleSheets(movement);
            
            // Increment BOL counter if this is a delivery
            if (type === 'delivery') {
                bolCounter++;
                localStorage.setItem('bolCounter', bolCounter);
            }
            
            // Update dashboard
            updateDashboard();
            
            // Close modal
            closeMovementModal();
            
            // Show success message
            showNotification('Movimiento registrado exitosamente', 'success');
        }

        function updateStockData(movement) {
            const hidrocooler = movement.hidrocooler;
            const bins = movement.bins;
            
            switch(movement.type) {
                case 'reception':
                    stockData[hidrocooler].available += bins;
                    break;
                case 'delivery':
                    stockData[hidrocooler].available -= bins;
                    stockData[hidrocooler].withGrowers += bins;
                    break;
                case 'return':
                    stockData[hidrocooler].withGrowers -= bins;
                    stockData[hidrocooler].fruitInHidrocooler += bins;
                    break;
                case 'dispatch':
                    stockData[hidrocooler].fruitInHidrocooler -= bins;
                    stockData[hidrocooler].dispatched += bins;
                    break;
            }
        }

        // Dashboard functions
        function updateDashboard() {
            // Calculate totals
            let totalBins = 0;
            let totalAvailable = 0;
            let totalFruit = 0;
            let totalDispatched = 0;
            
            Object.values(stockData).forEach(data => {
                totalBins += data.available + data.fruitInHidrocooler + data.withGrowers;
                totalAvailable += data.available;
                totalFruit += data.fruitInHidrocooler;
                totalDispatched += data.dispatched;
            });
            
            // Update metric cards
            document.getElementById('totalBins').textContent = totalBins;
            document.getElementById('availableStock').textContent = totalAvailable;
            document.getElementById('fruitInHidrocooler').textContent = totalFruit;
            document.getElementById('dispatchedBins').textContent = totalDispatched;
            
            // Update hidrocooler cards
            ['SHUKINS', 'SMAGH', 'REF'].forEach(hidrocooler => {
                const prefix = hidrocooler.toLowerCase();
                const data = stockData[hidrocooler];
                
                document.getElementById(prefix + 'Stock').textContent = `${data.available}/400 BINS`;
                document.getElementById(prefix + 'Fruit').textContent = `${data.fruitInHidrocooler} BINS`;
                document.getElementById(prefix + 'Dispatched').textContent = `${data.dispatched} BINS`;
                
                if (hidrocooler !== 'REF') {
                    const withGrowersElement = document.getElementById(prefix + 'WithGrowers');
                    if (withGrowersElement) {
                        withGrowersElement.textContent = `${data.withGrowers} BINS`;
                    }
                }
            });
            
            // Update charts
            updateCharts();
        }

        function updateRecentMovements() {
            const tbody = document.getElementById('recentMovements');
            tbody.innerHTML = '';
            
            // Get last 10 movements
            const recentMovements = movementData.slice(-10).reverse();
            
            recentMovements.forEach(movement => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const typeNames = {
                    'reception': currentLanguage === 'es' ? 'Recepci√≥n Vac√≠os' : 'Empty Reception',
                    'delivery': currentLanguage === 'es' ? 'Entrega a Growers' : 'Delivery to Growers',
                    'return': currentLanguage === 'es' ? 'Retorno Llenos' : 'Full Return',
                    'dispatch': currentLanguage === 'es' ? 'Despacho Kelowna' : 'Dispatch Kelowna'
                };
                
                // Create BOL download button for delivery movements
                let bolColumn = '-';
                if (movement.type === 'delivery' && movement.bolNumber) {
                    bolColumn = `<button onclick="downloadBOLFromMovement(${movement.id})" class="bol-download-btn">
                        <i class="fas fa-download"></i> BOL ${movement.bolNumber}
                    </button>`;
                }
                
                row.innerHTML = `
                    <td class="px-4 py-2">${new Date(movement.timestamp).toLocaleString()}</td>
                    <td class="px-4 py-2">${movement.hidrocooler}</td>
                    <td class="px-4 py-2">${typeNames[movement.type]}</td>
                    <td class="px-4 py-2">${movement.bins}</td>
                    <td class="px-4 py-2">${movement.company || movement.grower || ''}</td>
                    <td class="px-4 py-2">${movement.user}</td>
                    <td class="px-4 py-2">${bolColumn}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Chart functions
        function initializeCharts() {
            // Stock Chart
            const stockCtx = document.getElementById('stockChart').getContext('2d');
            stockChart = new Chart(stockCtx, {
                type: 'bar',
                data: {
                    labels: ['SHUKINS', 'SMAGH', 'REF'],
                    datasets: [{
                        label: 'Stock Disponible',
                        data: [280, 150, 320],
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Fruta en Hidrocooler',
                        data: [45, 32, 0],
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Movement Chart
            const movementCtx = document.getElementById('movementChart').getContext('2d');
            movementChart = new Chart(movementCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Recepci√≥n', 'Entrega', 'Retorno', 'Despacho'],
                    datasets: [{
                        data: [25, 20, 15, 30],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateCharts() {
            if (!stockChart || !movementChart) return;

            // Update stock chart
            const stockValues = ['SHUKINS', 'SMAGH', 'REF'].map(h => stockData[h].available);
            const fruitValues = ['SHUKINS', 'SMAGH', 'REF'].map(h => stockData[h].fruitInHidrocooler);
            
            stockChart.data.datasets[0].data = stockValues;
            stockChart.data.datasets[1].data = fruitValues;
            stockChart.update();

            // Update movement chart
            const movementCounts = {
                reception: 0,
                delivery: 0,
                return: 0,
                dispatch: 0
            };
            
            movementData.forEach(movement => {
                if (movementCounts[movement.type] !== undefined) {
                    movementCounts[movement.type]++;
                }
            });
            
            movementChart.data.datasets[0].data = [
                movementCounts.reception,
                movementCounts.delivery,
                movementCounts.return,
                movementCounts.dispatch
            ];
            movementChart.update();
        }

        // Settings functions
        function loadSettings() {
            const url = localStorage.getItem('googleAppsScriptUrl') || GOOGLE_SCRIPT_URL;
            const urlInput = document.getElementById('googleScriptUrl');
            if (urlInput) {
                urlInput.value = url;
            }
            
            const adminPanel = document.getElementById('adminPanel');
            if (currentUser && currentUser.role === 'super_admin') {
                adminPanel.style.display = 'block';
            } else {
                adminPanel.style.display = 'none';
            }
        }

        function saveGoogleScriptConfig() {
            const url = document.getElementById('googleScriptUrl').value;
            localStorage.setItem('googleAppsScriptUrl', url);
            showNotification('Configuraci√≥n de Google Apps Script guardada', 'success');
        }

        function testGoogleSheetsConnection() {
            const url = localStorage.getItem('googleAppsScriptUrl') || GOOGLE_SCRIPT_URL;
            if (!url) {
                showNotification('Por favor configura la URL de Google Apps Script primero', 'error');
                return;
            }
            
            const testData = {
                action: 'test',
                message: 'Test connection from Mister Bins'
            };
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                showNotification('‚úÖ Conexi√≥n con Google Sheets exitosa', 'success');
                console.log('Google Sheets response:', data);
            })
            .catch(error => {
                showNotification('‚ùå Error conectando con Google Sheets', 'error');
                console.error('Error:', error);
            });
        }

        function testWhatsAppConnection() {
            showNotification('Reporte WhatsApp generado (integraci√≥n pendiente)', 'info');
        }

        // Google Sheets integration
function sendToGoogleSheets(movement) {
    const url = 'https://script.google.com/macros/s/AKfycbwJppLUn46VrWvKHQ4CX2Sfp29PqnODIZNTSaYjZHDsEYDmMU-RJ05TtSNwMgsVXWrmFw/exec';
    
    // Crear payload con estructura esperada por tu API v2.2
    const payload = {
        action: 'addMovement',
        sheetId: '1nDPw1PRQlTVAVq1SOAChncPyOE5NgWaIhD9aYjR21SU',
        movement: {
            timestamp: new Date().toISOString(),
            hidrocooler: movement.hidrocooler,
            type: movement.type,
            bins: movement.bins,
            totes: movement.totes,
            company: movement.company || '',
            driver: movement.driver || '',
            grower: movement.grower || '',
            variety: movement.variety || '',
            orchard: movement.orchard || '',
            harvestDate: movement.harvestDate || '',
            comments: movement.comments || '',
            user: movement.user,
            bolNumber: movement.bolNumber || ''
        }
    };
    
    console.log('üì§ Enviando a Google Sheets:', payload);
    
    // Enviar datos
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        console.log('üì• Respuesta recibida:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('‚úÖ Respuesta Google Sheets:', data);
        if (data.status === 'OK' || data.success) {
            showNotification('‚úÖ Datos enviados a Google Sheets correctamente', 'success');
        } else {
            console.error('‚ùå Error en respuesta:', data);
            showNotification('‚ö†Ô∏è Datos enviados pero respuesta inesperada', 'warning');
        }
    })
    .catch(error => {
        console.error('‚ùå Error enviando a Google Sheets:', error);
        showNotification('‚ùå Error conectando con Google Sheets', 'error');
    });
}

// Notification function
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Data persistence
function saveDataToStorage() {
    localStorage.setItem('movementData', JSON.stringify(movementData));
    localStorage.setItem('stockData', JSON.stringify(stockData));
    localStorage.setItem('bolCounter', bolCounter);
}

function loadDataFromStorage() {
    const savedMovements = localStorage.getItem('movementData');
    const savedStock = localStorage.getItem('stockData');
    const savedBolCounter = localStorage.getItem('bolCounter');
    
    if (savedMovements) {
        movementData = JSON.parse(savedMovements);
    }
    
    if (savedStock) {
        stockData = JSON.parse(savedStock);
    }
    
    if (savedBolCounter) {
        bolCounter = parseInt(savedBolCounter);
    }
}

    </script>
</body>
</html>
